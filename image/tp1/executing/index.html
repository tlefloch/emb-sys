<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>E. Executing commands on the Raspberry Pi OS image - Embedded systems</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../css/custom.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "E. Executing commands on the Raspberry Pi OS image";
        var mkdocs_page_input_path = "image/tp1/executing.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../..">
          <img src="../../../img/tux-logo.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Image</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" >Lab 1 - Setting-up Raspberry Pi OS Image</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../intro/">Lab 1 – Setting up Raspberry Pi OS image​</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../getting/">A. Getting the Raspberry Pi OS image</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../mounting/">B. Mounting the Raspberry Pi OS image on the host</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../increasing/">C. Increasing size of Raspberry Pi OS image</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../modifying/">D. Modifying the Raspberry Pi OS image</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">E. Executing commands on the Raspberry Pi OS image</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#starting-chroot">Starting chroot</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#standard-process">Standard process</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#using-host-network-in-chroot">Using host network in chroot</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#start_chrootbash">start_chroot.bash</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#run-chroot">Run chroot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#adding-a-sudo-user-with-chroot">Adding a sudo user with chroot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#enabling-the-rpi-console-for-debug-with-chroot">Enabling the RPI console for debug with chroot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#clean-termination-of-chroot">Clean termination of chroot</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#standard-process_1">Standard process</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#stop_chrootbash">stop_chroot.bash</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#run-apt-command-in-chroot">Run apt command in chroot</a>
    </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">QEMU</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../qemu/">Introduction to QEMU</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">Embedded systems</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Image</li>
          <li class="breadcrumb-item">Lab 1 - Setting-up Raspberry Pi OS Image</li>
      <li class="breadcrumb-item active">E. Executing commands on the Raspberry Pi OS image</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="e-executing-commands-on-the-raspberry-pi-os-image">E. Executing commands on the Raspberry Pi OS image</h1>
<h2 id="introduction">Introduction</h2>
<p>Changing values in configuration files in the image on host is
fairly easy (as seen before)<br />
But what about running a command in the image on host?
for example to change the password ?</p>
<div class="admonition warning">
<p class="admonition-title">Problem 1</p>
<p>Host executes X86 code while image contains ARM executables<br />
<em>Solution</em> : emulating ARM on X86 with QEMU (created by
Fabrice Bellard)<br />
--&gt; Read <a href="../../qemu/">Introduction to QEMU</a></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Problem 2</p>
<p>Host commands are under / (ex /bin/bash) while
image commands are under /mnt/rpi (ex
/mnt/rpi/bin/bash).<br />
<em>Solution</em> : changing the root (/) using chroot, introduced
in development of Version 7 Unix in 1979.</p>
</div>
<h2 id="starting-chroot">Starting chroot</h2>
<h3 id="standard-process">Standard process</h3>
<p>Prepare the Raspberry Pi OS image to be executed it on host ...
First we need to mount the system folder the same way they are
mounted on the real Raspberry Pi board</p>
<p>Mount the image in a loop device (we use /dev/loop50 as before)
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>losetup<span class="w"> </span>-P<span class="w"> </span>/dev/loop50<span class="w"> </span>imgs/2024-11-19-raspios-bookworm-arm64-lite.img
</code></pre></div></p>
<p>Mount the partitions (as before)
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>mount<span class="w"> </span>/dev/loop50p2<span class="w"> </span>/mnt/rpi
sudo<span class="w"> </span>mount<span class="w"> </span>/dev/loop50p1<span class="w"> </span>/mnt/rpi/boot
</code></pre></div></p>
<p>Mount the system folders to make them similar as
if we were executing on the actual Raspberry board
for example, /dev is an important folder that gives
access to all the devices : /mnt/rpi/dev must be translated to /dev
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>mount<span class="w"> </span>--bind<span class="w"> </span>/dev<span class="w"> </span>/mnt/rpi/dev/
</code></pre></div></p>
<div class="admonition note">
<p class="admonition-title">1 - Issue</p>
<p>Do the same for all the other system folders we need :</p>
<ul>
<li><code>/sys</code>, which is an interface to the kernel</li>
<li><code>/proc</code>, which is a virtual file system working as an interface to ongoing processes</li>
</ul>
</div>
<div class="admonition tip">
<p class="admonition-title">1 - Solution</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>mount<span class="w"> </span>--bind<span class="w"> </span>/sys<span class="w"> </span>/mnt/rpi/sys/
sudo<span class="w"> </span>mount<span class="w"> </span>--bind<span class="w"> </span>/proc<span class="w"> </span>/mnt/rpi/proc/
</code></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A PTY (pseudo-terminal) is a kernel feature that lets programs behave as if they are attached to a real terminal.
Examples of things that require PTYs:</p>
<ul>
<li>interactive shells (bash, sh)</li>
<li>sudo</li>
<li>ssh</li>
<li>su</li>
<li>screen, tmux</li>
<li>apt / dpkg (often indirectly)</li>
<li>systemctl</li>
</ul>
<p>So in a chroot, no PTYs = lots of weird failures.</p>
</div>
<p>PTYs (/dev/pts/*), pseudo-terminals are provided by the devpts filesystem. Mount it using :
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>/mnt/rpi/dev/pts
sudo<span class="w"> </span>mount<span class="w"> </span>-t<span class="w"> </span>devpts<span class="w"> </span>devpts<span class="w"> </span>/mnt/rpi/dev/pts
sudo<span class="w"> </span>ln<span class="w"> </span>-sf<span class="w"> </span>pts/ptmx<span class="w"> </span>/mnt/rpi/dev/ptmx
</code></pre></div></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We need to disable some specific actions done solely on the
real board. The <code>/etc/ld.so.preload</code> file tells what libraries should be
loaded before the other. This does not work on the virtual
Raspberry Pi.</p>
<p>On modern Debian-based systems (including Raspberry Pi OS Bookworm = Debian 12) :</p>
<ul>
<li><code>/etc/ld.so.preload</code> is optional</li>
<li>It is not created by default</li>
<li>The dynamic linker only reads it if it exists</li>
</ul>
<p>The file <code>/etc/ld.so.preload</code> should only be executed on actual board.<br />
Check if there is such a file :
<div class="highlight"><pre><span></span><code>ls<span class="w"> </span>/mnt/rpi/etc/ld.so.preload
</code></pre></div>
It should return nothing. If it returns <code>/mnt/rpi/etc/ld.so.preload</code>, it means you are using an old version, then for safety keep a backup version and comment the content of <code>/mnt/rpi/etc/ld.so.preload</code>.</p>
</div>
<p>We also need to add QEMU to translate ARM code to X86 64
code so it can be executed on the host computer. QEMU is added
by just copying the emulator in the Raspberry Pi OS image :
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>cp<span class="w"> </span>/usr/bin/qemu-arm-static<span class="w"> </span>/mnt/rpi/usr/bin/
</code></pre></div></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Make sure you installed QEMU following <a href="../../qemu/">Introduction to QEMU</a> instructions</p>
</div>
<h3 id="using-host-network-in-chroot">Using host network in chroot</h3>
<p>For some applications, we may need access to Internet.<br />
A practical example is the use of the packet manager with apt</p>
<p>We need to copy some of the host configuration files (here
/etc/resolv.conf) on the image before running chroot</p>
<p>First save the current config as a backup
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>cp<span class="w"> </span>/mnt/rpi/etc/resolv.conf<span class="w"> </span>/mnt/rpi/etc/resolv.conf.bck
</code></pre></div>
Copy config from host
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>cp<span class="w"> </span>/etc/resolv.conf<span class="w"> </span>/mnt/rpi/etc/resolv.conf
</code></pre></div></p>
<p>Now all should be prepared correctly.</p>
<h3 id="start_chrootbash">start_chroot.bash</h3>
<p>To avoid reapeating the previous series of commands and make more easy the use of chroot we can create a bash script
to run before chroot : <code>start_chroot.bash</code>.</p>
<p>Example of a starting script. Create the file <code>start_chroot.bash</code> in rpilab.
<div class="highlight"><pre><span></span><code>nano<span class="w"> </span>start_chroot.bash
</code></pre></div></p>
<p>And copy the following :
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1"># command parameter ($1) is the path to the RPI image file</span>
<span class="c1"># example of use :</span>
<span class="c1"># source start_chroot.bash imgs/2024-11-19-raspios-bookworm-arm64-lite.img</span>
sudo<span class="w"> </span>losetup<span class="w"> </span>-P<span class="w"> </span>/dev/loop50<span class="w"> </span><span class="nv">$1</span>
sudo<span class="w"> </span>mount<span class="w"> </span>/dev/loop50p2<span class="w"> </span>/mnt/rpi
sudo<span class="w"> </span>mount<span class="w"> </span>/dev/loop50p1<span class="w"> </span>/mnt/rpi/boot
sudo<span class="w"> </span>mount<span class="w"> </span>--bind<span class="w"> </span>/dev<span class="w"> </span>/mnt/rpi/dev/
sudo<span class="w"> </span>mount<span class="w"> </span>--bind<span class="w"> </span>/sys<span class="w"> </span>/mnt/rpi/sys/
sudo<span class="w"> </span>mount<span class="w"> </span>--bind<span class="w"> </span>/proc<span class="w"> </span>/mnt/rpi/proc/
sudo<span class="w"> </span>mount<span class="w"> </span>-t<span class="w"> </span>devpts<span class="w"> </span>devpts<span class="w"> </span>/mnt/rpi/dev/pts
sudo<span class="w"> </span>ln<span class="w"> </span>-sf<span class="w"> </span>pts/ptmx<span class="w"> </span>/mnt/rpi/dev/ptmx
sudo<span class="w"> </span>cp<span class="w"> </span>/usr/bin/qemu-arm-static<span class="w"> </span>/mnt/rpi/usr/bin/
sudo<span class="w"> </span>cp<span class="w"> </span>/mnt/rpi/etc/resolv.conf<span class="w"> </span>/mnt/rpi/etc/resolv.conf.bck
sudo<span class="w"> </span>cp<span class="w"> </span>/etc/resolv.conf<span class="w"> </span>/mnt/rpi/etc/resolv.conf
</code></pre></div></p>
<h2 id="run-chroot">Run chroot</h2>
<p><strong>We can now chroot and run the RPI image as if it was on a actual board !</strong></p>
<p><code>/mnt/rpi</code> will be our new <code>/</code> and we execute /bin/bash to start a terminal</p>
<div class="admonition note">
<p class="admonition-title">2 - Issue</p>
<p>Use <code>chroot</code> to make <code>/mnt/rpi</code> the new root and start a bash terminal</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <code>/bin/bash</code> command is used to open a new bash shell</p>
</div>
<!-- !!! Tip "2 - Solution"

    ```bash
    sudo chroot /mnt/rpi /bin/bash
    ``` -->

<p>We have now a root prompt # and we can execute commands on
the RPI image, for example :</p>
<ul>
<li>to create an new user ue41 with root privileges (sudo)</li>
<li>set locale to en US.UTF-8 using raspi-config (5 Localisation options)</li>
<li>set keyboard to French layout using raspi-config</li>
<li>to enable the console with raspi-config (to access the actual RPI board without
network) for future use with real board (may be done later)</li>
<li>run apt update</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To leave the <code>chroot</code> shell, use  <code>Ctrl + D</code></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>With some experience, we can do most of the setup of the RPI
image without using the actual board !!!</p>
</div>
<h2 id="adding-a-sudo-user-with-chroot">Adding a sudo user with chroot</h2>
<p>To do this, we make sure we are in chroot (# prompt) on the
Raspberry PI OS, and we will proceed in two steps :</p>
<p>We will create a new user called ue41, password ue41.<br />
(no need to answer all the
questions !!! most of them can be left empty)</p>
<div class="admonition note">
<p class="admonition-title">3 - Issue</p>
<p>Use <code>adduser</code> to create the ue41 user</p>
</div>
<!-- !!! Tip "3 - Solution"

    ```bash
    adduser ue41
    ``` -->

<p>Execute <code>visudo</code> command to give sudo permission to the
created user
<div class="highlight"><pre><span></span><code>visudo
</code></pre></div>
A file should open.<br />
Add a line with ue41 user here :
<div class="highlight"><pre><span></span><code>%sudo   ALL=(ALL:ALL) ALL
ue41    ALL=(ALL:ALL) ALL
</code></pre></div></p>
<p>Then write and save (nano commands)</p>
<h2 id="enabling-the-rpi-console-for-debug-with-chroot">Enabling the RPI console for debug with chroot</h2>
<p>The console is an easy tool for debug, it can be connected to the host via FTDI USB
cable and can be accessed on Ubuntu via /dev/ttyUSB0 device. Hence, it can work
even if the network is not or badly defined.<br />
To enable the console, Raspberry Pi OS offers several ways :</p>
<ul>
<li>adding the line enable uart=1 at the end of the file /mnt/rpi/boot/config.txt
with standard mount of boot partition,</li>
<li>adding the line enable uart=1 at the end of the file boot/config.txt in chroot
mode,</li>
<li>use raspi-config in chroot mode.</li>
</ul>
<p>As we have started chroot, we will use the raspi-config tool.</p>
<p>Simply execute raspi-config under chroot prompt <code>#</code>
<div class="highlight"><pre><span></span><code>raspi-config
</code></pre></div></p>
<p>Then go in <code>Interface Options</code> and enable <code>Serial Port</code>. </p>
<p>More details on <a href="https://www.raspberrypi.com/documentation/computers/configuration.html">raspi-config Documetation</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>raspi-config can be used to easily configure a lot of features such as the network, the locale language, etc</p>
</div>
<h2 id="clean-termination-of-chroot">Clean termination of chroot</h2>
<h3 id="standard-process_1">Standard process</h3>
<p>To exit chroot, just type <code>ctrl+D</code> or <code>exit</code>.</p>
<p>To return to a standard host configuration we have to :</p>
<ul>
<li>go back to the original network config if we used the host's</li>
<li>uncomment actions in /mnt/rpi/etc/ld.so.preload if we did so</li>
<li>unmount all the RPI image system folders</li>
<li>stop the loop device with RPI image</li>
</ul>
<p>Restore the network config
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>cp<span class="w"> </span>/mnt/rpi/etc/resolv.conf.bck<span class="w"> </span>/mnt/rpi/etc/resolv.conf
</code></pre></div></p>
<p>Unmount all volumes at once
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>umount<span class="w"> </span>/mnt/rpi/<span class="o">{</span>dev/pts,dev,sys,proc,boot,<span class="o">}</span>
</code></pre></div>
Stop the loop device with RPI image
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>losetup<span class="w"> </span>-d<span class="w"> </span>/dev/loop50
</code></pre></div></p>
<h3 id="stop_chrootbash">stop_chroot.bash</h3>
<p>Just like we did for starting chroot we can create a bash script to run after chroot: <code>stop_chroot.bash</code></p>
<div class="admonition note">
<p class="admonition-title">4 - Issue</p>
<p>Write a <code>stop_chroot.bash</code> script to cleanly return to the standard host configuration.</p>
</div>
<!-- !!! Tip "4 - Solution"

    Create the file `stop_chroot.bash`.
    <div class="highlight"><pre><span></span><code>nano<span class="w"> </span>stop_chroot.bash
</code></pre></div>
    And copy the following :
    ```bash
    #!/bin/bash

    # usage :
    # source stop_chroot.bash
    sudo cp /mnt/rpi/etc/resolv.conf.bck /mnt/rpi/etc/resolv.conf
    sudo umount /mnt/rpi/{dev/pts,dev,sys,proc,boot,}
    sudo losetup -d /dev/loop50
    ``` -->

<h2 id="run-apt-command-in-chroot">Run apt command in chroot</h2>
<p>Now with the scripts you should be able to only use the following :</p>
<div class="highlight"><pre><span></span><code><span class="nb">source</span><span class="w"> </span>start_chroot.bash<span class="w"> </span>imgs/2024-11-19-raspios-bookworm-arm64-lite.img
sudo<span class="w"> </span>chroot<span class="w"> </span>/mnt/rpi<span class="w"> </span>/bin/bash
apt<span class="w"> </span>update
<span class="c1"># type ctrl-D to exit chroot</span>
<span class="nb">source</span><span class="w"> </span>stop_chroot.bash
</code></pre></div>
<p><strong>Congrats ! You successfully ended this lab !</strong></p>
<p>Keep your modified image on your computer as it will be used in a next lab.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../modifying/" class="btn btn-neutral float-left" title="D. Modifying the Raspberry Pi OS image"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../qemu/" class="btn btn-neutral float-right" title="Introduction to QEMU">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../modifying/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../qemu/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
