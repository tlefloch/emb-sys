<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>E. Executing commands on the Raspberry Pi OS image - Embedded systems</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../css/custom.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "E. Executing commands on the Raspberry Pi OS image";
        var mkdocs_page_input_path = "image/tp1/executing.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../..">
          <img src="../../../img/tux-logo.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Image</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../qemu/">Introduction to QEMU</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >TD/TP Setting-up Raspberry Pi OS Image</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../intro/">Introduction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../getting/">A. Getting the Raspberry Pi OS image</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../mounting/">B. Mounting the Raspberry Pi OS image on the host</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../increasing/">C. Increasing size of Raspberry Pi OS image</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../modifying/">D. Modifying the Raspberry Pi OS image</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">E. Executing commands on the Raspberry Pi OS image</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#starting-chroot">Starting chroot</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#standard-process">Standard process</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#using-host-network-in-chroot">Using host network in chroot</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#start_chrootbash">start_chroot.bash</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#run-chroot">Run chroot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#adding-a-sudo-user-with-chroot">Adding a sudo user with chroot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#enabling-the-rpi-console-for-debug-with-chroot">Enabling the RPI console for debug with chroot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#clean-termination-of-chroot">Clean termination of chroot</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#standard-process_1">Standard process</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#stop_chrootbash">stop_chroot.bash</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#run-apt-command-in-chroot">Run apt command in chroot</a>
    </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >TD/TP Running the Raspberry Pi OS on a virtual machine on host</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../tp2/intro/">Introduction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../tp2/getting/">A. Getting the Raspberry Pi OS image</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Docker</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../docker">None</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">Embedded systems</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Image</li>
          <li class="breadcrumb-item">TD/TP Setting-up Raspberry Pi OS Image</li>
      <li class="breadcrumb-item active">E. Executing commands on the Raspberry Pi OS image</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="e-executing-commands-on-the-raspberry-pi-os-image">E. Executing commands on the Raspberry Pi OS image</h1>
<h2 id="introduction">Introduction</h2>
<p>Changing values in configuration files in the image on host is
fairly easy (as seen before)<br />
But what about running a command in the image on host?
for example to change the password ?</p>
<p><strong>Problem 1</strong> : host executes X86 code while image contains
ARM executables<br />
<em>Solution</em> : emulating ARM on X86 with QEMU (created by
Fabrice Bellard)<br />
--&gt; Read <a href="../../qemu/">Introduction to QEMU</a></p>
<p><strong>Problem 2</strong> : host commands are under / (ex /bin/bash) while
image commands are under /mnt/rpi (ex
/mnt/rpi/bin/bash).<br />
<em>Solution</em> : changing the root (/) using chroot, introduced
in development of Version 7 Unix in 1979.</p>
<h2 id="starting-chroot">Starting chroot</h2>
<h3 id="standard-process">Standard process</h3>
<p>Prepare the Raspberry Pi OS image to be executed it on host ...
First we need to mount the system folder the same way they are
mount on the real Raspberry Pi board</p>
<p>Mount the image in a loop device (we use /dev/loop50 as before)</p>
<pre><code class="language-bash">sudo losetup -P /dev/loop50 imgs/2024-11-19-raspios-bookworm-arm64-lite.img
</code></pre>
<p>Mount the partitions (as before)</p>
<pre><code class="language-bash">sudo mount /dev/loop50p2 /mnt/rpi
sudo mount /dev/loop50p1 /mnt/rpi/boot
</code></pre>
<p>Mount the system folders to make them similar as
if we were executing on the actual Raspberry board
for example, /dev is an important folder that gives
access to all the devices : /mnt/rpi/dev must be translated to /dev</p>
<pre><code class="language-bash">sudo mount --bind /dev /mnt/rpi/dev/
</code></pre>
<p>we do the same for all the other system folders we need :</p>
<pre><code class="language-bash">sudo mount --bind /sys /mnt/rpi/sys/
sudo mount --bind /proc /mnt/rpi/proc/
sudo mount --bind /dev/pts /mnt/rpi/dev/pts
</code></pre>
<p>Then we need to disable some specific actions done solely on the
real board. The <code>/etc/ld.so.preload</code> file tells what libraries should be
loaded before the other. This does not work on the virtual
Raspberry Pi, so we comment the content of this file (by adding #
at the beginning of the lines).</p>
<p>On modern Debian-based systems (including Raspberry Pi OS Bookworm = Debian 12) :</p>
<ul>
<li><code>/etc/ld.so.preload</code> is optional</li>
<li>It is not created by default</li>
<li>The dynamic linker only reads it if it exists</li>
</ul>
<p>The file <code>/etc/ld.so.preload</code> should only be executed on actual board.<br />
Check if there is such a file :</p>
<pre><code class="language-bash">ls /mnt/rpi/etc/ld.so.preload
</code></pre>
<p>It should return nothing. If it returns <code>/mnt/rpi/etc/ld.so.preload</code>, it means you are using an old version, then for safety keep a backup version and comment the content of <code>/mnt/rpi/etc/ld.so.preload</code>.</p>
<p>We also need to add QEMU to translate ARM code to X86 64
code so it can be executed on the host computer. QEMU is added
by just copying the emulator in the Raspberry Pi OS image :</p>
<pre><code class="language-bash">sudo cp /usr/bin/qemu-arm-static /mnt/rpi/usr/bin/
</code></pre>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Make sure you installed QEMU following <a href="../../qemu/">Introduction to QEMU</a> instructions</p>
</div>
<h3 id="using-host-network-in-chroot">Using host network in chroot</h3>
<p>For some applications, we may need access to Internet.<br />
A practical example is the use of the packet manager with apt</p>
<p>We need to copy some of the host configuration files (here
/etc/resolv.conf) on the image before running chroot</p>
<p>First save the current config as a backup</p>
<pre><code class="language-bash">sudo cp /mnt/rpi/etc/resolv.conf /mnt/rpi/etc/resolv.conf.bck
</code></pre>
<p>Copy config from host</p>
<pre><code class="language-bash">sudo cp /etc/resolv.conf /mnt/rpi/etc/resolv.conf
</code></pre>
<p>Now all should be prepared correctly.</p>
<h3 id="start_chrootbash">start_chroot.bash</h3>
<p>To avoid reapeating the previous series of commands and make more easy the use of chroot we can create a bash script
to run before chroot : <code>start_chroot.bash</code> and <code>stop_chroot.bash</code>.</p>
<p>Example of a starting script. Create the file <code>start_chroot.bash</code> in rpilab.</p>
<pre><code class="language-bash">nano start_chroot.bash
</code></pre>
<p>And copy the following :</p>
<pre><code class="language-bash">#!/bin/bash

# command parameter ($1) is the path to the RPI image file
# example of use :
# source start_chroot.bash imgs/2024-11-19-raspios-bookworm-arm64-lite.img
sudo losetup -P /dev/loop50 $1
sudo mount /dev/loop50p2 /mnt/rpi
sudo mount /dev/loop50p1 /mnt/rpi/boot
sudo mount --bind /dev /mnt/rpi/dev/
sudo mount --bind /sys /mnt/rpi/sys/
sudo mount --bind /proc /mnt/rpi/proc/
sudo mount --bind /dev/pts /mnt/rpi/dev/pts
sudo cp /usr/bin/qemu-arm-static /mnt/rpi/usr/bin/
sudo cp /mnt/rpi/etc/resolv.conf /mnt/rpi/etc/resolv.conf.bck
sudo cp /etc/resolv.conf /mnt/rpi/etc/resolv.conf
</code></pre>
<h2 id="run-chroot">Run chroot</h2>
<p><strong>We can now chroot and run the RPI image as if it was on a actual board !</strong>
/mnt/rpi will be our new /
and we execute /bin/bash to start a terminal</p>
<pre><code class="language-bash">sudo chroot /mnt/rpi /bin/bash
</code></pre>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To leave this prompt, use  <code>Ctrl + D</code></p>
</div>
<p>We have now a root prompt # and we can execute commands on
the RPI image, for example :</p>
<ul>
<li>to create an new user ue41 with root privileges (sudo)</li>
<li>set locale to en US.UTF-8 using raspi-config (5 Localisation options)</li>
<li>set keyboard to French layout using raspi-config</li>
<li>to enable the console with raspi-config (to access the actual RPI board without
network) for future use with real board (may be done later)</li>
<li>run apt update</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>With some experience, we can do most of the setup of the RPI
image without using the actual board !!!</p>
</div>
<h2 id="adding-a-sudo-user-with-chroot">Adding a sudo user with chroot</h2>
<p>To do this, we make sure we are in chroot (# prompt) on the
Raspberry PI OS, and we will proceed in two steps :</p>
<p>We will create a new user called ue41, password ue41.<br />
(no need to answer all the
questions !!! most of them can be left empty)</p>
<pre><code class="language-bash">adduser ue41
</code></pre>
<p>Execute <code>visudo</code> command to give sudo permission to the
created user</p>
<pre><code class="language-bash">visudo
</code></pre>
<p>A file should open.<br />
Add a line with ue41 user here :</p>
<pre><code>%sudo   ALL=(ALL:ALL) ALL
ue41    ALL=(ALL:ALL) ALL
</code></pre>
<p>Then write and save (nano commands)</p>
<h2 id="enabling-the-rpi-console-for-debug-with-chroot">Enabling the RPI console for debug with chroot</h2>
<p>The console is an easy tool for debug, it can be connected to the host via FTDI USB
cable and can be accessed on Ubuntu via /dev/ttyUSB0 device. Hence, it can work
even if the network is not or badly defined.<br />
To enable the console, Raspberry Pi OS offers several ways :</p>
<ul>
<li>adding the line enable uart=1 at the end of the file /mnt/rpi/boot/config.txt
with standard mount of boot partition,</li>
<li>adding the line enable uart=1 at the end of the file boot/config.txt in chroot
mode,</li>
<li>use raspi-config in chroot mode.</li>
</ul>
<p>As we have started chroot, we will use the raspi-config tool.</p>
<p>Simply execute raspi-config under chroot prompt #</p>
<pre><code class="language-bash">raspi-config
</code></pre>
<p>Then go in <code>Interface Options</code> and enable <code>Serial Port</code>. </p>
<p>More details on <a href="https://www.raspberrypi.com/documentation/computers/configuration.html">raspi-config Documetation</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>raspi-config can be used to easily configure a lot of features such as the network, the locale language, etc</p>
</div>
<h2 id="clean-termination-of-chroot">Clean termination of chroot</h2>
<h3 id="standard-process_1">Standard process</h3>
<p>To exit chroot, just type <code>ctrl+D</code> or <code>exit</code>.</p>
<p>To return to a standard host configuration we have to :</p>
<ul>
<li>go back to the original network config if we used the host's</li>
<li>uncomment actions in /mnt/rpi/etc/ld.so.preload if we did so</li>
<li>unmount all the RPI image system folders</li>
<li>stop the loop device with RPI image</li>
</ul>
<p>Restore the network config</p>
<pre><code class="language-bash">sudo cp /mnt/rpi/etc/resolv.conf.bck /mnt/rpi/etc/resolv.conf
</code></pre>
<p>Unmount all volumes at once</p>
<pre><code class="language-bash">sudo umount /mnt/rpi/{dev/pts,dev,sys,proc,boot,}
</code></pre>
<p>Stop the loop device with RPI image</p>
<pre><code class="language-bash">sudo losetup -d /dev/loop50
</code></pre>
<h3 id="stop_chrootbash">stop_chroot.bash</h3>
<p>Just like we did for starting chroot we can create a bash cript to run after chroot: <code>stop_chroot.bash</code></p>
<p>Example of a stopping script. Create the file <code>stop_chroot.bash</code>.</p>
<pre><code class="language-bash">nano stop_chroot.bash
</code></pre>
<p>And copy the following :</p>
<pre><code class="language-bash">#!/bin/bash

# usage :
# source stop_chroot.bash
sudo cp /mnt/rpi/etc/resolv.conf.bck /mnt/rpi/etc/resolv.conf
sudo umount /mnt/rpi/{dev/pts,dev,sys,proc,boot,}
sudo losetup -d /dev/loop50
</code></pre>
<h2 id="run-apt-command-in-chroot">Run apt command in chroot</h2>
<p>Now with the scripts you should be able to only use the following :</p>
<pre><code class="language-bash">source start_chroot.bash imgs/2024-11-19-raspios-bookworm-arm64-lite.img
sudo chroot /mnt/rpi /bin/bash
apt update
# type ctrl-D to exit chroot
source stop_chroot.bash
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../modifying/" class="btn btn-neutral float-left" title="D. Modifying the Raspberry Pi OS image"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../tp2/intro/" class="btn btn-neutral float-right" title="Introduction">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../modifying/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../tp2/intro/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
