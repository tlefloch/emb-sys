<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>C. Setting up network for ssh access - Embedded systems</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../css/custom.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "C. Setting up network for ssh access";
        var mkdocs_page_input_path = "image/lab3/setting.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../..">
          <img src="../../../img/tux-logo.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Raspberry Pi OS Labs</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" >Lab 1 - Setting-up Raspberry Pi OS Image</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../lab1/intro/">Lab 1 - Introduction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../lab1/getting/">A. Getting the Raspberry Pi OS image</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../lab1/mounting/">B. Mounting the Raspberry Pi OS image on the host</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../lab1/increasing/">C. Increasing size of Raspberry Pi OS image</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../lab1/modifying/">D. Modifying the Raspberry Pi OS image</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../lab1/executing/">E. Executing commands on the Raspberry Pi OS image</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Lab 2 - Running the Raspberry Pi OS on a virtual machine on host</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../lab2/intro/">Lab 2 - Introduction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../lab2/getting/">A. Getting the Raspberry Pi OS image</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../lab2/installVM/">B. Install QEMU ARM virtual machine (VM)</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../lab2/using/">C. Using QEMU Virtual Machine</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Lab 3 - Setting-up and working with the Raspberry Pi OS without graphical user interface</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../intro/">Lab 3 - Introduction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../writing/">A. Writing the Raspberry Pi OS image on the sd-card</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../connecting/">B. Accessing the headless RPI without network</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">C. Setting up network for ssh access</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#recap-4-ways-to-access-the-rpi-without-network">Recap : 4 ways to access the RPI without network</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configure-the-network-interfaces">Configure the network interfaces</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#enable-wifi">Enable Wifi</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#configure-a-wifi-interface">Configure a Wifi interface</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#configure-an-ethernet-interface">Configure an ethernet interface</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#trying-to-find-the-ip-address-of-the-rpi">Trying to find the IP address of the RPI</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#from-the-host-via-network">From the host via network</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#with-the-console-via-minicom">With the console (via minicom)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#enable-ssh">Enable ssh</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../saving/">D. Cloning the image (Optional)</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">QEMU</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../qemu/">Introduction to QEMU</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">Embedded systems</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Raspberry Pi OS Labs</li>
          <li class="breadcrumb-item">Lab 3 - Setting-up and working with the Raspberry Pi OS without graphical user interface</li>
      <li class="breadcrumb-item active">C. Setting up network for ssh access</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="c-setting-up-network-for-ssh-access">C. Setting up network for ssh access</h1>
<h2 id="recap-4-ways-to-access-the-rpi-without-network">Recap : 4 ways to access the RPI without network</h2>
<p>We have now 4 ways to setup the RPI image without network, for
example to set the network parameters.<br />
Note that all these 4 ways do not require the use of a display
connected on the HDMI plug and mouse+keyboard connected on
the USB plugs of the RPI BOARD</p>
<ol>
<li>mount the RPI image (raspios bookworm) on host as a standard
file system to modify configuration files</li>
<li>chroot on the RPI sd-card image on host to directly execute
RPI configuration commands on host</li>
<li>QEMU virtual machine running the RPI image from the
sd-card</li>
<li>RPI console (terminal) on the actual RPI board via the FTDI
USB cable, accessed with minicom (or similar tools) on the
host</li>
</ol>
<p>If you do not want to use the serial terminal or want to be able to log in to your Raspberry Pi over a network connection, you can give your Pi a static IP address, connect it to your network (or to your computer via a crossover/Ethernet cable), and log in via SSH.</p>
<p>We will now setup the network on the RPI
The simplest way is using the 4th method: the RPI console(terminal) via the FTDI USB cable and minicom, because we can use the real board and <code>raspi-config</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Windows and Mac cannot natively access the filesystem partition of the Raspberry Pi image on the SD card because its format is <code>ext4</code>, the native Linux filesystem format. As a result, the easiest solutions are to access a computer with a Linux operating system or to use the 4th method (which is our case now).  </p>
</div>
<h2 id="configure-the-network-interfaces">Configure the network interfaces</h2>
<p>We are still connected to the RPI board via serial</p>
<h3 id="enable-wifi">Enable Wifi</h3>
<p>To list all the network interfaces, we use the <code>ifconfig</code> command.</p>
<p>There should be 3 interfaces :</p>
<ul>
<li>lo: local interface (no physical network)</li>
<li>eth0: ethernet RJ45 wired network</li>
<li>wlan0: Wi-Fi wireless (radio) network</li>
</ul>
<p>If wlan0 is not listed, as it is the case on a fresh install, you must specify the country where you use your device. This allows your device to choose the correct frequency bands for 5 GHz networking.<br />
We need to set the Wi-Fi country to FR.</p>
<p>Use raspi-config to set WLAN country to France</p>
<h3 id="configure-a-wifi-interface">Configure a Wifi interface</h3>
<p>Since Raspberry Pi OS Bookworm (2023), the network is managed by NetworkManager, while on previous versions it was managed by dhcpcd.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On versions older than Bookworm, there are 2 files to modify :</p>
<ul>
<li><code>/etc/wpa_supplicant/wpa_supplicant.conf</code> : to set the Wi-Fi</li>
<li><code>/etc/dhcpcd.conf</code> : to set the IP addresses.</li>
</ul>
<p>Follow this tutorial if you need to do so :<br />
<a href="https://learn.sparkfun.com/tutorials/headless-raspberry-pi-setup">https://learn.sparkfun.com/tutorials/headless-raspberry-pi-setup</a></p>
</div>
<p>A static IP address wil be use to simplify the access to the RPI via ssh.
Both ethernet and Wi-Fi interfaces will be defined, each with a
different IP address.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For each network interface, a file will be created in <code>/etc/NetworkManager/system-connections</code></p>
</div>
<p>We configure the network with NetworkManager using the <code>nmcli</code> (Network Manager Command Line Interface) command tool.</p>
<div class="admonition note">
<p class="admonition-title">1 - Issue</p>
<p>Configure the Wifi connection to the <strong>iot</strong> (password: enstaL@b) network using <code>nmcli</code>
Help on <a href="https://www.raspberrypi.com/documentation/computers/configuration.html#wireless-networking-command-line">https://www.raspberrypi.com/documentation/computers/configuration.html#wireless-networking-command-line</a> </p>
</div>
<!-- !!! Tip "1 - Solution"

    <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>nmcli<span class="w"> </span>--ask<span class="w"> </span>dev<span class="w"> </span>wifi<span class="w"> </span>connect<span class="w"> </span>iot
</code></pre></div>
    Enter password -->

<p>Now check a file has been created for your wifi interface in <code>/etc/NetworkManager/system-connections</code></p>
<div class="highlight"><pre><span></span><code>ls<span class="w"> </span>/etc/NetworkManager/system-connections
</code></pre></div>
<p>Have a look to the created file. It should look like this :
<div class="highlight"><pre><span></span><code><span class="o">[</span>connection<span class="o">]</span>
<span class="nv">id</span><span class="o">=</span>iot
<span class="nv">uuid</span><span class="o">=</span>74a90378-23c2-493e-a524-138a17c10184
<span class="nv">type</span><span class="o">=</span>wifi
interface-name<span class="o">=</span>wlan0

<span class="o">[</span>wifi<span class="o">]</span>
<span class="nv">mode</span><span class="o">=</span>infrastructure
<span class="nv">ssid</span><span class="o">=</span>iot

<span class="o">[</span>wifi-security<span class="o">]</span>
auth-alg<span class="o">=</span>open
key-mgmt<span class="o">=</span>wpa-psk
<span class="nv">psk</span><span class="o">=</span>enstaL@b

<span class="o">[</span>ipv4<span class="o">]</span>
<span class="nv">method</span><span class="o">=</span>auto

<span class="o">[</span>ipv6<span class="o">]</span>
addr-gen-mode<span class="o">=</span>default
<span class="nv">method</span><span class="o">=</span>auto

<span class="o">[</span>proxy<span class="o">]</span>
</code></pre></div></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If we can't access the real board and we want to setup the network on the Raspberry Pi OS image from our computer,
we would have to create and configure this file manually because <code>nmcli</code> doesn't work with chroot.</p>
</div>
<p>It is possible to encrypt the password using the <code>wpa_passphrase</code> tool for security reasons but this is optional.</p>
<div class="highlight"><pre><span></span><code>wpa_passphrase<span class="w"> </span>&lt;network_ssid&gt;<span class="w"> </span>&lt;password&gt;
</code></pre></div>
<p>This will return an encrypted password. Copy it in your wifi interface configuration file instead of the real password</p>
<h3 id="configure-an-ethernet-interface">Configure an ethernet interface</h3>
<p>We may want to use a ethernet cable to connect to the RPI (for example to get a higher data rate than via Wifi), in this case
we can set eth0.</p>
<p>First, find the ethernet connection name (probably something like <code>Wired connection 1</code> or <code>eth0</code>):
<div class="highlight"><pre><span></span><code>nmcli<span class="w"> </span>connection<span class="w"> </span>show
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>nmcli<span class="w"> </span>connection<span class="w"> </span>modify<span class="w"> </span><span class="s2">&quot;Wired connection 1&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>ipv4.method<span class="w"> </span>manual<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>ipv4.addresses<span class="w"> </span><span class="m">192</span>.168.1.10/24<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>ipv4.gateway<span class="w"> </span><span class="s2">&quot;192.168.1.1&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>ipv4.dns<span class="w"> </span><span class="s2">&quot;172.0.0.35 172.0.0.37 8.8.8.8 8.8.4.4&quot;</span>
</code></pre></div>
<p>Apply the change :</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>nmcli<span class="w"> </span>connection<span class="w"> </span>down<span class="w"> </span><span class="s2">&quot;Wired connection 1&quot;</span>
sudo<span class="w"> </span>nmcli<span class="w"> </span>connection<span class="w"> </span>up<span class="w"> </span><span class="s2">&quot;Wired connection 1&quot;</span>
</code></pre></div>
<h2 id="trying-to-find-the-ip-address-of-the-rpi">Trying to find the IP address of the RPI</h2>
<h3 id="from-the-host-via-network">From the host via network</h3>
<p>In this case, suppose we don't have a FTDI USB cable and we configured the network interfaces on the RPI OS image on host</p>
<p>We need to proceed to a systematic search over all the network of your
hostname (the name you have given earlier in Lab 1).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Can take a very long time with 16 bits masks. Faster, around one minute, with 24 bits masks.</p>
</div>
<p>On host, we can scan all devices on the iot network, this takes quite a long time (1 minute or more).
The iot network's ip address is 172.19.144.0<br />
Be carefull, on iot the network mask is 255.255.252.0 or /22</p>
<div class="admonition note">
<p class="admonition-title">2 - Issue</p>
<p>Scan the iot network using <code>nmap</code>.
Do this before and after booting up the raspberry pi, and find its ip address. </p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Find the correct option to do a <strong>Nmap Ping Scan</strong>, which is a lot quicker than using nmap without option.</p>
</div>
<!-- !!! Tip "2 - Solution"

    ```bash
    nmap -sP 172.19.144.0/22
    ``` -->

<h3 id="with-the-console-via-minicom">With the console (via minicom)</h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This second option is easier but we need a serial connection to the real board, so more hardware</p>
</div>
<p>Simply show network configuration using
<div class="highlight"><pre><span></span><code>ifconfig
</code></pre></div></p>
<p>and look for inet.</p>
<h2 id="enable-ssh">Enable ssh</h2>
<p>The RPI image (even the lite one) has all softwares installed to
access it via ssh. However, port 22 is not accessible by default !</p>
<p>Try from host :
<div class="highlight"><pre><span></span><code>ssh<span class="w"> </span>ue41@&lt;ip_addr&gt;
</code></pre></div></p>
<p>The permission is denied !</p>
<p>Enable ssh on the RPI board using :
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>ssh
</code></pre></div></p>
<p>Then start the service :
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>ssh
</code></pre></div></p>
<p>Check it is working :</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>status<span class="w"> </span>ssh
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We can also do it with <code>raspi-config</code></p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>When preparing the OS image on host or on the sd-card we would simply create a ssh file
in the boot folder. When booting the real board with this image, a first-boot service checks for /boot/ssh,
and enable ssh if it finds it. <strong>It only works on first boot !</strong></p>
<p>If you have already booted the board once with your image on your sd-card but you haven't created the /boot/ssh file before and you can't
access the real board via serial, this method won't work.<br />
Instead :  </p>
<ul>
<li>Either use chroot on the sd-card and type :</li>
</ul>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>ssh
</code></pre></div>
<ul>
<li>Either create the /boot/ssh file on your local OS image and write it again on the sd-card</li>
</ul>
</div>
<p>Now try again :
<div class="highlight"><pre><span></span><code>ssh<span class="w"> </span>ue41@&lt;ip_addr&gt;
</code></pre></div></p>
<p>You should now be able to connect via ssh ! You finished the setup !</p>
<p><strong>Congrats ! You ended this lab series !</strong>  </p>
<p>You will soon use your knowledge to configure an embedded Linux for a robot.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../connecting/" class="btn btn-neutral float-left" title="B. Accessing the headless RPI without network"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../saving/" class="btn btn-neutral float-right" title="D. Cloning the image (Optional)">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../connecting/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../saving/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
